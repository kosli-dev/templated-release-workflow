name: Kosli policy action
description: Create Kosli policies from YAML files

author: Kosli Dev Team

# Define your inputs here.
inputs:
  policy_files:
    description: 'Comma-separated list of policy file names without extension (e.g., "artifact-provenance,trail-compliance")'
    required: true

runs:
  using: "composite"
  steps:
    
    - name: Set GitHub Path
      run: echo "$GITHUB_ACTION_PATH" >> $GITHUB_PATH
      shell: bash
      env:
        GITHUB_ACTION_PATH: ${{ github.action_path }}
    
    - name: Create Kosli policies
      run: |
        IFS=',' read -ra POLICY_NAMES <<< "${{ inputs.policy_files }}"
        for policy_name in "${POLICY_NAMES[@]}"; do
          # Trim whitespace
          policy_name=$(echo "$policy_name" | xargs)
          # Construct the filename by appending .yaml
          policy_file="${policy_name}.yaml"
          
          if [ -f "$GITHUB_ACTION_PATH/$policy_file" ]; then
            echo "Creating policy '$policy_name' from file '$policy_file'"
            kosli create policy "$policy_name" "$GITHUB_ACTION_PATH/$policy_file"
          else
            echo "Warning: Policy file '$policy_file' not found in action directory"
            exit 1
          fi
        done
      shell: bash
